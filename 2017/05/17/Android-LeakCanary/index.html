<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="åƒè¶Š">





<title>Android LeakCanary | åƒè¶Š</title>



    <link rel="icon" href="/image/icon.jpeg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">åƒè¶Šçš„åšå®¢</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">æ–‡ç« </a>
                
                    <a class="menu-item" href="/category">åˆ†ç±»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">åƒè¶Šçš„åšå®¢</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">æ–‡ç« </a>
                
                    <a class="menu-item" href="/category">åˆ†ç±»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Android LeakCanary</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">åƒè¶Š</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2017-05-17&nbsp;&nbsp;22:23:45</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><strong>ã€å‚è€ƒæ–‡ç« ã€‘</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/leavesCZY/AndroidGuide/blob/master/android_opensource/5-LeakCanary%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3.md">LeakCanary æºç è¯¦è§£</a> â€”â€” ä¸‹é¢æ•´æ–‡æ‘˜æŠ„</li>
</ol>
<blockquote>
<p>å…¬ä¼—å·ï¼š<a target="_blank" rel="noopener" href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adbc507fc3704fd8955aae739a433db2~tplv-k3u1fbpfcp-zoom-1.image">å­—èŠ‚æ•°ç»„</a></p>
<p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
</blockquote>
<blockquote>
<p>å¯¹äº Android Developer æ¥è¯´ï¼Œå¾ˆå¤šå¼€æºåº“éƒ½æ˜¯å±äº<strong>å¼€å‘å¿…å¤‡</strong>çš„çŸ¥è¯†ç‚¹ï¼Œä»ä½¿ç”¨æ–¹å¼åˆ°å®ç°åŸç†å†åˆ°æºç è§£æï¼Œè¿™äº›éƒ½éœ€è¦æˆ‘ä»¬æœ‰ä¸€å®šç¨‹åº¦çš„äº†è§£å’Œè¿ç”¨èƒ½åŠ›ã€‚æ‰€ä»¥æˆ‘æ‰“ç®—æ¥å†™ä¸€ç³»åˆ—å…³äºå¼€æºåº“<strong>æºç è§£æ</strong>å’Œ<strong>å®æˆ˜æ¼”ç»ƒ</strong>çš„æ–‡ç« ï¼Œåˆå®šçš„ç›®æ ‡æ˜¯ <strong>EventBusã€ARouterã€LeakCanaryã€Retrofitã€Glideã€OkHttpã€Coil</strong> ç­‰ä¸ƒä¸ªçŸ¥åå¼€æºåº“ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ğŸ¤£ğŸ¤£</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/square/leakcanary/">LeakCanary</a> æ˜¯ç”± <a target="_blank" rel="noopener" href="https://github.com/square">Square</a> å…¬å¸å¼€æºçš„ç”¨äº Android çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…å‘ç°å†…å­˜æ³„éœ²æƒ…å†µå¹¶ä¸”æ‰¾å‡ºæ³„éœ²æºå¤´ï¼Œæœ‰åŠ©äºå‡å°‘ <code>OutOfMemoryError</code> æƒ…å†µçš„å‘ç”Ÿã€‚åœ¨ç›®å‰çš„åº”ç”¨å¼€å‘ä¸­ä¹Ÿç®—ä½œæ˜¯æ€§èƒ½ä¼˜åŒ–çš„ä¸€ä¸ªé‡è¦å®ç°é€”å¾„ï¼Œå¾ˆå¤šé¢è¯•å®˜åœ¨è€ƒå¯Ÿæ€§èƒ½ä¼˜åŒ–æ—¶éƒ½ä¼šé—®åˆ° LeakCanary çš„å®ç°åŸç†</p>
<p>æœ¬æ–‡å°±æ¥å¯¹å…¶å®ç°åŸç†è¿›è¡Œåˆ†æï¼Œå…·ä½“çš„ Git ç‰ˆæœ¬èŠ‚ç‚¹æ˜¯ï¼š<strong>9f62126e</strong>ï¼Œæ¥äº†è§£ LeakCanary çš„æ•´ä½“è¿è¡Œæµç¨‹å’Œå®ç°åŸç† ğŸ˜‚ğŸ˜‚</p>
<h1 id="ä¸€ã€æ”¯æŒçš„å†…å­˜æ³„éœ²ç±»å‹"><a href="#ä¸€ã€æ”¯æŒçš„å†…å­˜æ³„éœ²ç±»å‹" class="headerlink" title="ä¸€ã€æ”¯æŒçš„å†…å­˜æ³„éœ²ç±»å‹"></a>ä¸€ã€æ”¯æŒçš„å†…å­˜æ³„éœ²ç±»å‹</h1><p>æˆ‘ä»¬ç»å¸¸è¯´ LeakCanary èƒ½æ£€æµ‹åˆ°åº”ç”¨å†…å‘ç”Ÿçš„å†…å­˜æ³„éœ²ï¼Œé‚£ä¹ˆå®ƒåˆ°åº•å…·ä½“æ”¯æŒä»€ä¹ˆç±»å‹çš„å†…å­˜æ³„éœ²æƒ…å†µå‘¢ï¼ŸLeakCanary   å®˜ç½‘æœ‰å¯¹æ­¤è¿›è¡Œä»‹ç»ï¼š</p>
<p>LeakCanary automatically detects leaks of the following objects:</p>
<ul>
<li>destroyed <code>Activity</code> instances</li>
<li>destroyed <code>Fragment</code> instances</li>
<li>destroyed fragment <code>View</code> instances</li>
<li>cleared <code>ViewModel</code> instances</li>
</ul>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä» LeakCanary çš„ <code>AppWatcher.Config</code> è¿™ä¸ªç±»æ‰¾åˆ°ç­”æ¡ˆã€‚Config ç±»ç”¨äºé…ç½®æ˜¯å¦å¼€å¯å†…å­˜æ£€æµ‹ï¼Œä»å…¶é…ç½®é¡¹å°±å¯ä»¥çœ‹å‡ºæ¥ leakcanary æ”¯æŒï¼š<strong>Activityã€Fragmentã€FragmentViewã€ViewModel</strong> ç­‰å››ç§ç±»å‹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Config</span>(</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Whether AppWatcher should automatically watch destroyed activity instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Defaults to true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> watchActivities: <span class="built_in">Boolean</span> = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Whether AppWatcher should automatically watch destroyed fragment instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Defaults to true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> watchFragments: <span class="built_in">Boolean</span> = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Whether AppWatcher should automatically watch destroyed fragment view instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Defaults to true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> watchFragmentViews: <span class="built_in">Boolean</span> = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Whether AppWatcher should automatically watch cleared [androidx.lifecycle.ViewModel]</span></span><br><span class="line"><span class="comment">     * instances.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Defaults to true.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> watchViewModels: <span class="built_in">Boolean</span> = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * How long to wait before reporting a watched object as retained.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Default to 5 seconds.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> watchDurationMillis: <span class="built_in">Long</span> = TimeUnit.SECONDS.toMillis(<span class="number">5</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Deprecated, this didn&#x27;t need to be a part of the API.</span></span><br><span class="line"><span class="comment">     * Used to indicate whether AppWatcher should watch objects (by keeping weak references to</span></span><br><span class="line"><span class="comment">     * them). Currently a no-op.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If you do need to stop watching objects, simply don&#x27;t pass them to [objectWatcher].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated(<span class="string">&quot;This didn&#x27;t need to be a part of LeakCanary&#x27;s API. No-Op.&quot;</span>)</span></span><br><span class="line">    <span class="keyword">val</span> enabled: <span class="built_in">Boolean</span> = <span class="literal">true</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h1 id="äºŒã€åˆå§‹åŒ–"><a href="#äºŒã€åˆå§‹åŒ–" class="headerlink" title="äºŒã€åˆå§‹åŒ–"></a>äºŒã€åˆå§‹åŒ–</h1><p>å¦‚ä»Šï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¼•å…¥ LeakCanary åªéœ€è¦æ·»åŠ å¦‚ä¸‹ä¾èµ–å³å¯ï¼Œæ— é¡»ä»»ä½•çš„åˆå§‹åŒ–è¡Œä¸ºç­‰é™„åŠ æ“ä½œï¼Œå½“åº”ç”¨å¯åŠ¨æ—¶ LeakCanary å°±ä¼šè‡ªåŠ¨å¯åŠ¨å¹¶å¼€å§‹ç›‘æµ‹äº†</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  <span class="comment">// debugImplementation because LeakCanary should only run in debug builds.</span></span><br><span class="line">  debugImplementation <span class="string">&#x27;com.squareup.leakcanary:leakcanary-android:2.4&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œåƒè¿™ç±»ç¬¬ä¸‰æ–¹åº“éƒ½æ˜¯éœ€è¦ç”±å¤–éƒ¨ä¼ å…¥ä¸€ä¸ª <code>ApplicationContext</code> å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–å¹¶å¯åŠ¨çš„ï¼ŒLeakCanary çš„ 1.x ç‰ˆæœ¬ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä½†åœ¨ 2.x ç‰ˆæœ¬ä¸­ï¼ŒLeakCanary å°†åˆå§‹è¿‡ç¨‹äº¤ç”± <code>AppWatcherInstaller</code> è¿™ä¸ª <code>ContentProvider</code> æ¥è‡ªåŠ¨å®Œæˆ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title class_">AppWatcherInstaller</span> : <span class="type">ContentProvider</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [MainProcess] automatically sets up the LeakCanary code that runs in the main app process.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">MainProcess</span> : <span class="type">AppWatcherInstaller</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * When using the `leakcanary-android-process` artifact instead of `leakcanary-android`,</span></span><br><span class="line"><span class="comment">     * [LeakCanaryProcess] automatically sets up the LeakCanary code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">LeakCanaryProcess</span> : <span class="type">AppWatcherInstaller</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> application = context!!.applicationContext <span class="keyword">as</span> Application</span><br><span class="line">        AppWatcher.manualInstall(application)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>ContentProvider</code> ä¼šåœ¨ <code>Application</code> è¢«åˆ›å»ºä¹‹å‰å°±ç”±ç³»ç»Ÿè°ƒç”¨å…¶ <code>onCreate()</code> æ–¹æ³•æ¥å®Œæˆåˆå§‹åŒ–ï¼Œæ‰€ä»¥ LeakCanary é€šè¿‡ <code>AppWatcherInstaller</code> å°±å¯ä»¥æ‹¿åˆ° <code>Context</code> æ¥å®Œæˆåˆå§‹åŒ–å¹¶éšåº”ç”¨ä¸€èµ·å¯åŠ¨ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å°±ç®€åŒ–äº†ä½¿ç”¨è€…çš„å¼•å…¥æˆæœ¬ã€‚è€Œä¸”ç”±äºæˆ‘ä»¬çš„å¼•ç”¨æ–¹å¼æ˜¯ <code>debugImplementation</code>ï¼Œæ‰€ä»¥<strong>æ­£å¼ç‰ˆæœ¬</strong>ä¼šè‡ªåŠ¨ç§»é™¤å¯¹ LeakCanary çš„æ‰€æœ‰å¼•ç”¨ï¼Œè¿›ä¸€æ­¥ç®€åŒ–äº†å¼•å…¥æˆæœ¬</p>
<p>Jetpack ä¹ŸåŒ…å«äº†ä¸€ä¸ªç»„ä»¶æ¥å®ç°<strong>é€šè¿‡ ContentProvider æ¥å®Œæˆåˆå§‹åŒ–çš„é€»è¾‘</strong>ï¼š<a target="_blank" rel="noopener" href="https://juejin.im/post/6847902224069165070">AppStartup</a>ã€‚åœ¨å®ç°æ€è·¯ä¸Šä¸¤è€…å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªä¸‰æ–¹åº“éƒ½é€šè¿‡è‡ªå®šä¹‰ <code>ContentProvider</code> æ¥å®ç°åˆå§‹åŒ–çš„è¯ï¼Œé‚£ä¹ˆåº”ç”¨çš„å¯åŠ¨é€Ÿåº¦å°±ä¼šå¾ˆæ„Ÿäººäº†å§ :joy:ï¼Œæ‰€ä»¥ Jetpack å®˜æ–¹æ¨å‡ºçš„ <code>AppStartup</code> åº”è¯¥æ˜¯ä»¥åçš„ä¸»æµæ‰å¯¹</p>
<p><code>AppWatcherInstaller</code> æœ€ç»ˆä¼šå°† <code>Application</code> å¯¹è±¡ä¼ ç»™ <code>InternalAppWatcher</code> çš„ <code>install(Application)</code> æ–¹æ³•</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Note: this object must load fine in a JUnit environment</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> InternalAppWatcher &#123;</span><br><span class="line"></span><br><span class="line">  Â·Â·Â·</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">val</span> objectWatcher = ObjectWatcher(</span><br><span class="line">      clock = clock,</span><br><span class="line">      checkRetainedExecutor = checkRetainedExecutor,</span><br><span class="line">      isEnabled = &#123; <span class="literal">true</span> &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">install</span><span class="params">(application: <span class="type">Application</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">//æ£€æµ‹æ˜¯å¦åœ¨ main çº¿ç¨‹</span></span><br><span class="line">    checkMainThread()</span><br><span class="line">    <span class="comment">//é¿å…é‡å¤åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>::application.isInitialized) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    InternalAppWatcher.application = application</span><br><span class="line">    <span class="keyword">if</span> (isDebuggableBuild) &#123;</span><br><span class="line">      SharkLog.logger = DefaultCanaryLog()</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//æ‹¿åˆ°é»˜è®¤é…ç½®ï¼Œé»˜è®¤å››ç§ç±»å‹éƒ½è¿›è¡Œæ£€æµ‹</span></span><br><span class="line">    <span class="keyword">val</span> configProvider = &#123; AppWatcher.config &#125;</span><br><span class="line">    <span class="comment">//æ£€æµ‹ Activity</span></span><br><span class="line">    ActivityDestroyWatcher.install(application, objectWatcher, configProvider)</span><br><span class="line">    <span class="comment">//æ£€æµ‹ Fragmentã€FragmentViewã€ViewModel</span></span><br><span class="line">    FragmentDestroyWatcher.install(application, objectWatcher, configProvider)</span><br><span class="line">    onAppWatcherInstalled(application)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Â·Â·Â·</span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LeakCanary å…·ä½“è¿›è¡Œå†…å­˜æ³„éœ²æ£€æµ‹çš„é€»è¾‘å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>ObjectWatcherã€‚æ£€æµ‹ Object çš„å†…å­˜æ³„éœ²æƒ…å†µ</li>
<li>ActivityDestroyWatcherã€‚æ£€æµ‹ Activity çš„å†…å­˜æ³„éœ²æƒ…å†µ</li>
<li>FragmentDestroyWatcherã€‚æ£€æµ‹ Fragmentã€FragmentViewã€ViewModel çš„å†…å­˜æ³„éœ²æƒ…å†µ</li>
</ul>
<p>å½“ä¸­ï¼Œ<code>ActivityDestroyWatcher</code> å’Œ <code>FragmentDestroyWatcher</code> éƒ½éœ€è¦ä¾é  <code>ObjectWatcher</code> æ¥å®Œæˆï¼Œå› ä¸º <code>Activityã€Fragmentã€FragmentViewã€ViewModel</code>  æœ¬è´¨ä¸Šéƒ½å±äºä¸åŒç±»å‹çš„ <code>Object</code> </p>
<h1 id="ä¸‰ã€ObjectWatcherï¼šæ£€æµ‹ä»»æ„å¯¹è±¡"><a href="#ä¸‰ã€ObjectWatcherï¼šæ£€æµ‹ä»»æ„å¯¹è±¡" class="headerlink" title="ä¸‰ã€ObjectWatcherï¼šæ£€æµ‹ä»»æ„å¯¹è±¡"></a>ä¸‰ã€ObjectWatcherï¼šæ£€æµ‹ä»»æ„å¯¹è±¡</h1><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ä¸å†è¢«æˆ‘ä»¬å¼•ç”¨æ—¶ï¼Œå¦‚æœè¯¥å¯¹è±¡ç”±äºä»£ç é”™è¯¯æˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´è¿Ÿè¿Ÿæ— æ³•è¢«ç³»ç»Ÿå›æ”¶ï¼Œæ­¤æ—¶å°±æ˜¯å‘ç”Ÿäº†å†…å­˜æ³„éœ²ã€‚é‚£ä¹ˆ LeakCanary æ˜¯æ€ä¹ˆçŸ¥é“åº”ç”¨æ˜¯å¦å‘ç”Ÿäº†å†…å­˜æ³„éœ²å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªå¯ä»¥ä¾é å¼•ç”¨é˜Ÿåˆ— <code>ReferenceQueue</code> æ¥å®ç°ã€‚å…ˆæ¥çœ‹ä¸ªå°ä¾‹å­</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: leavesCZY</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Github</span>ï¼šhttps://github.com/leavesCZY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> referenceQueue = ReferenceQueue&lt;Pair&lt;String, <span class="built_in">Int</span>&gt;?&gt;()</span><br><span class="line">    <span class="keyword">var</span> pair: Pair&lt;String, <span class="built_in">Int</span>&gt;? = Pair(<span class="string">&quot;name&quot;</span>, <span class="number">24</span>)</span><br><span class="line">    <span class="keyword">val</span> weakReference = WeakReference(pair, referenceQueue)</span><br><span class="line"></span><br><span class="line">    println(referenceQueue.poll()) <span class="comment">//null</span></span><br><span class="line"></span><br><span class="line">    pair = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    System.gc()</span><br><span class="line">    <span class="comment">//GC åä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œç­‰å¾… pair è¢«å›æ”¶</span></span><br><span class="line">    Thread.sleep(<span class="number">4000</span>)</span><br><span class="line"></span><br><span class="line">    println(referenceQueue.poll()) <span class="comment">//java.lang.ref.WeakReference@d716361</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ GC è¿‡å <code>referenceQueue.poll()</code> çš„è¿”å›å€¼å˜æˆäº†<strong>é null</strong>ï¼Œè¿™æ˜¯ç”±äº <code>WeakReference</code> å’Œ <code>ReferenceQueue</code> çš„ä¸€ä¸ªç»„åˆç‰¹æ€§å¯¼è‡´çš„ï¼šåœ¨å£°æ˜ä¸€ä¸ª <code>WeakReference</code> å¯¹è±¡æ—¶å¦‚æœåŒæ—¶ä¼ å…¥äº† <code>ReferenceQueue</code> ä½œä¸ºæ„é€ å‚æ•°çš„è¯ï¼Œé‚£ä¹ˆå½“ <code>WeakReference</code> æŒæœ‰çš„å¯¹è±¡è¢« GC å›æ”¶æ—¶ï¼ŒJVM å°±ä¼šæŠŠè¿™ä¸ª<strong>å¼±å¼•ç”¨</strong>å­˜å…¥ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¹‹ä¸­ã€‚ä¾é è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°å†…å­˜æ³„éœ²çš„æ£€æµ‹äº†</p>
<p>ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·æŒ‰è¿”å›é”®é€€å‡º Activity æ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¯¥ Activity å¯¹è±¡åº”è¯¥åœ¨ä¸ä¹…åå°±è¢«ç³»ç»Ÿå›æ”¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬ Activity çš„ <code>onDestroy</code> å›è°ƒï¼Œåœ¨å›è°ƒæ—¶æŠŠ Activity å¯¹è±¡ä¿å­˜åˆ°å’Œ <code>ReferenceQueue</code> å…³è”çš„ <code>WeakReference</code> ä¸­ï¼Œåœ¨ä¸€æ®µæ—¶é—´åï¼ˆå¯ä»¥ä¸»åŠ¨è§¦å‘å‡ æ¬¡ GCï¼‰æ£€æµ‹ <code>ReferenceQueue</code> ä¸­æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœä¸€ç›´ä¸º null çš„è¯å°±è¯´æ˜å‘ç”Ÿäº†å†…å­˜æ³„éœ²ã€‚LeakCanary å°±æ˜¯é€šè¿‡è¿™ç§æ–¹æ³•æ¥å®ç°çš„</p>
<p><code>ObjectWatcher</code> ä¸­å°±å°è£…äº†ä¸Šè¿°é€»è¾‘ï¼Œè¿™é‡Œæ¥çœ‹çœ‹å…¶å®ç°é€»è¾‘</p>
<p><code>ObjectWatcher</code> çš„èµ·å§‹æ–¹æ³•æ˜¯ <code>watch(Any, String)</code>ï¼Œè¯¥æ–¹æ³•å°±ç”¨äºç›‘å¬æŒ‡å®šå¯¹è±¡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * References passed to [watch].</span></span><br><span class="line"><span class="comment"> * ç”¨äºä¿å­˜è¦ç›‘å¬çš„å¯¹è±¡ï¼ŒmapKey æ˜¯è¯¥å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ã€mapValue æ˜¯è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> watchedObjects = mutableMapOf&lt;String, KeyedWeakReference&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">//KeyedWeakReference å…³è”çš„å¼•ç”¨é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> queue = ReferenceQueue&lt;Any&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Watches the provided [watchedObject].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> description Describes why the object is watched.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Synchronized</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">watch</span><span class="params">(watchedObject: <span class="type">Any</span>, description: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    removeWeaklyReachableObjects()</span><br><span class="line">    <span class="comment">//ä¸º watchedObject ç”Ÿæˆä¸€ä¸ªå”¯ä¸€æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">val</span> key = UUID.randomUUID().toString()</span><br><span class="line">    <span class="keyword">val</span> watchUptimeMillis = clock.uptimeMillis()</span><br><span class="line">    <span class="comment">//åˆ›å»º watchedObject å…³è”çš„å¼±å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">val</span> reference = KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    watchedObjects[key] = reference</span><br><span class="line">    checkRetainedExecutor.execute &#123;</span><br><span class="line">        moveToRetained(key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>watch()</code> æ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼š</p>
<ol>
<li>ä¸ºæ¯ä¸ª <code>watchedObject</code> ç”Ÿæˆä¸€ä¸ª<strong>å”¯ä¸€æ ‡è¯† key</strong>ï¼Œé€šè¿‡è¯¥ key æ„å»ºä¸€ä¸ª <code>watchedObject</code> çš„å¼±å¼•ç”¨ <code>KeyedWeakReference</code>ï¼Œå°†è¯¥å¼±å¼•ç”¨ä¿å­˜åˆ° <code>watchedObjects</code> ä¸­ã€‚<code>ObjectWatcher</code> å¯ä»¥å…ˆåç›‘æµ‹å¤šä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šå…ˆè¢«å­˜å…¥åˆ° <code>watchedObjects</code> ä¸­</li>
<li>å¤–éƒ¨é€šè¿‡ä¼ å…¥çš„ <code>checkRetainedExecutor</code> æ¥æŒ‡å®šæ£€æµ‹å†…å­˜æ³„éœ²çš„è§¦å‘æ—¶æœºï¼Œé€šè¿‡ <code>moveToRetained</code> æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦çœŸçš„å‘ç”Ÿäº†å†…å­˜æ³„éœ²</li>
</ol>
<p><code>KeyedWeakReference</code>  æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>WeakReference</code> å­ç±»ï¼ŒåŒ…å«ä¸€ä¸ªå”¯ä¸€ key æ¥æ ‡è¯†ç‰¹å®šå¯¹è±¡ï¼Œä¹ŸåŒ…å«ä¸€ä¸ª <code>retainedUptimeMillis</code> å­—æ®µç”¨æ¥æ ‡è®°æ˜¯å¦å‘ç”Ÿäº†å†…å­˜æ³„éœ²</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">KeyedWeakReference</span>(</span><br><span class="line">        referent: Any,</span><br><span class="line">        <span class="keyword">val</span> key: String,</span><br><span class="line">        <span class="keyword">val</span> description: String,</span><br><span class="line">        <span class="keyword">val</span> watchUptimeMillis: <span class="built_in">Long</span>,</span><br><span class="line">        referenceQueue: ReferenceQueue&lt;Any&gt;</span><br><span class="line">) : WeakReference&lt;Any&gt;(</span><br><span class="line">        referent, referenceQueue</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Time at which the associated object ([referent]) was considered retained, or -1 if it hasn&#x27;t</span></span><br><span class="line"><span class="comment">     * been yet.</span></span><br><span class="line"><span class="comment">     * ç”¨äºæ ‡è®° referent æ˜¯å¦è¿˜æœªè¢«å›æ”¶ï¼Œæ˜¯çš„è¯åˆ™å€¼ä¸ä¸º -1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Volatile</span></span><br><span class="line">    <span class="keyword">var</span> retainedUptimeMillis = -<span class="number">1L</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@Volatile</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">var</span> heapDumpUptimeMillis = <span class="number">0L</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>moveToRetained</code> æ–¹æ³•å°±ç”¨äºåˆ¤æ–­æŒ‡å®š key å…³è”çš„å¯¹è±¡æ˜¯å¦å·²ç»æ³„éœ²ï¼Œå¦‚æœæ²¡æœ‰æ³„éœ²åˆ™ç§»é™¤å¯¹è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œæœ‰æ³„éœ²çš„è¯åˆ™æ›´æ–°å…¶ <code>retainedUptimeMillis</code> å€¼ï¼Œä»¥æ­¤æ¥æ ‡è®°å…¶å‘ç”Ÿäº†æ³„éœ²ï¼Œå¹¶åŒæ—¶é€šè¿‡å›è°ƒ <code>onObjectRetainedListeners</code> æ¥åˆ†æå†…å­˜æ³„éœ²é“¾</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Synchronized</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">moveToRetained</span><span class="params">(key: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    removeWeaklyReachableObjects()</span><br><span class="line">    <span class="keyword">val</span> retainedRef = watchedObjects[key]</span><br><span class="line">    <span class="keyword">if</span> (retainedRef != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è®°å½•å½“å‰æ—¶é—´</span></span><br><span class="line">        retainedRef.retainedUptimeMillis = clock.uptimeMillis()</span><br><span class="line">        onObjectRetainedListeners.forEach &#123; it.onObjectRetained() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœåˆ¤æ–­åˆ°ä¸€ä¸ªå¯¹è±¡æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„éœ²ï¼Œé‚£ä¹ˆå°±ç§»é™¤å¯¹è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨</span></span><br><span class="line"><span class="comment">//æ­¤æ–¹æ³•ä¼šå…ˆåè°ƒç”¨å¤šæ¬¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">removeWeaklyReachableObjects</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// WeakReferences are enqueued as soon as the object to which they point to becomes weakly</span></span><br><span class="line">    <span class="comment">// reachable. This is before finalization or garbage collection has actually happened.</span></span><br><span class="line">    <span class="keyword">var</span> ref: KeyedWeakReference?</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ref = queue.poll() <span class="keyword">as</span> KeyedWeakReference?</span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ ref ä¸ä¸º nullï¼Œè¯´æ˜ ref å…³è”çš„å¯¹è±¡æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„éœ²ï¼Œé‚£ä¹ˆå°±ç§»é™¤å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">            watchedObjects.remove(ref.key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (ref != <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å››ã€ActivityDestroyWatcherï¼šæ£€æµ‹Activity"><a href="#å››ã€ActivityDestroyWatcherï¼šæ£€æµ‹Activity" class="headerlink" title="å››ã€ActivityDestroyWatcherï¼šæ£€æµ‹Activity"></a>å››ã€ActivityDestroyWatcherï¼šæ£€æµ‹Activity</h1><p>ç†è§£äº† <code>ObjectWatcher</code> çš„æµç¨‹åæ¥çœ‹ <code>ActivityDestroyWatcher</code> å°±ä¼šæ¯”è¾ƒç®€å•äº†ã€‚<code>ActivityDestroyWatcher</code> ä¼šå‘ <code>Application</code> æ³¨å†Œä¸€ä¸ª <code>ActivityLifecycleCallbacks</code> å›è°ƒï¼Œå½“æ”¶åˆ°æ¯ä¸ª Activity æ‰§è¡Œäº† <code>onDestroy</code> çš„å›è°ƒåï¼Œå°±ä¼šå°†å°† Activity å¯¹è±¡è½¬äº¤ç”± <code>ObjectWatcher</code> æ¥è¿›è¡Œç›‘å¬</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">ActivityDestroyWatcher</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(<span class="keyword">private</span> <span class="keyword">val</span> objectWatcher: ObjectWatcher, <span class="keyword">private</span> <span class="keyword">val</span> configProvider: () -&gt; Config) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> lifecycleCallbacks = <span class="keyword">object</span> : Application.ActivityLifecycleCallbacks <span class="keyword">by</span> noOpDelegate() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityDestroyed</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (configProvider().watchActivities) &#123;</span><br><span class="line">                objectWatcher.watch(activity, <span class="string">&quot;<span class="subst">$&#123;activity::class.java.name&#125;</span> received Activity#onDestroy() callback&quot;</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">install</span><span class="params">(application: <span class="type">Application</span>, objectWatcher: <span class="type">ObjectWatcher</span>, configProvider: () -&gt; <span class="type">Config</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> activityDestroyWatcher = ActivityDestroyWatcher(objectWatcher, configProvider)</span><br><span class="line">            application.registerActivityLifecycleCallbacks(activityDestroyWatcher.lifecycleCallbacks)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="äº”ã€FragmentDestroyWatcherï¼šæ£€æµ‹Fragment"><a href="#äº”ã€FragmentDestroyWatcherï¼šæ£€æµ‹Fragment" class="headerlink" title="äº”ã€FragmentDestroyWatcherï¼šæ£€æµ‹Fragment"></a>äº”ã€FragmentDestroyWatcherï¼šæ£€æµ‹Fragment</h1><p>åš Android åº”ç”¨å¼€å‘çš„åº”è¯¥éƒ½çŸ¥é“ï¼Œç°åœ¨ Google æä¾›çš„åŸºç¡€ä¾èµ–åŒ…åˆ†ä¸ºäº† <strong>Support</strong> å’Œ <strong>AndroidX</strong> ä¸¤ç§ï¼Œ<strong>Support</strong> ç‰ˆæœ¬å·²ç»ä¸å†ç»´æŠ¤ï¼Œä¸»æµçš„éƒ½æ˜¯ä½¿ç”¨ <strong>AndroidX</strong> äº†ã€‚è€Œ LeakCanary ä¸ºäº†ç…§é¡¾è€é¡¹ç›®ï¼Œå°±è´´å¿ƒçš„ä¸ºè¿™ä¸¤ç§ç‰ˆæœ¬åˆ†åˆ«æä¾›äº† Fragment çš„å†…å­˜æ£€æµ‹åŠŸèƒ½</p>
<p><code>FragmentDestroyWatcher</code> å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªåˆ†å‘å™¨ï¼Œå®ƒä¼šæ ¹æ®å¤–éƒ¨ç¯å¢ƒçš„ä¸åŒæ¥é€‰æ‹©ä¸åŒçš„æ£€æµ‹æ‰‹æ®µï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼š</p>
<ul>
<li>ç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äº 8.0ã€‚ä½¿ç”¨ AndroidOFragmentDestroyWatcher æ¥æ£€æµ‹ Fragmentã€FragmentView çš„å†…å­˜æ³„éœ²</li>
<li>å¼€å‘è€…ä½¿ç”¨çš„æ˜¯ Support åŒ…ã€‚ä½¿ç”¨ AndroidSupportFragmentDestroyWatcher æ¥æ£€æµ‹ Fragmentã€FragmentView çš„å†…å­˜æ³„éœ²</li>
<li>å¼€å‘è€…ä½¿ç”¨çš„æ˜¯ AndroidX åŒ…ã€‚ä½¿ç”¨ AndroidXFragmentDestroyWatcher æ¥æ£€æµ‹ Fragmentã€FragmentViewã€ViewModel çš„å†…å­˜æ³„éœ²</li>
<li>é€šè¿‡åå°„ Class.forName æ¥åˆ¤æ–­å¼€å‘è€…ä½¿ç”¨çš„æ˜¯ Support åŒ…è¿˜æ˜¯ AndroidX åŒ…</li>
<li>ç”±äº Fragment éƒ½éœ€è¦è¢«æŒ‚è½½åœ¨ Activity ä¸Šï¼Œæ‰€æœ‰å‘ Application æ³¨å†Œä¸€ä¸ª ActivityLifecycleCallbackï¼Œæ¯å½“æœ‰ Activity è¢«åˆ›å»ºæ—¶å°±ç›‘å¬è¯¥ Activity å†…å¯èƒ½å­˜åœ¨çš„ Fragment</li>
</ul>
<blockquote>
<p>è¿™é‡Œä»¤æˆ‘å¾ˆç–‘æƒ‘çš„ä¸€ä¸ªç‚¹å°±æ˜¯ï¼šå½“ç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äº  8.0 æ—¶ï¼ŒAndroidOFragmentDestroyWatcher ä¸å°±ä¼šå’Œ AndroidSupportFragmentDestroyWatcher æˆ–è€… AndroidXFragmentDestroyWatcher é‡å¤äº†å—ï¼Ÿè¿™ç®—å’‹å›äº‹:joy:</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> FragmentDestroyWatcher &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> ANDROIDX_FRAGMENT_CLASS_NAME = <span class="string">&quot;androidx.fragment.app.Fragment&quot;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> ANDROIDX_FRAGMENT_DESTROY_WATCHER_CLASS_NAME =</span><br><span class="line">    <span class="string">&quot;leakcanary.internal.AndroidXFragmentDestroyWatcher&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Using a string builder to prevent Jetifier from changing this string to Android X Fragment</span></span><br><span class="line">  <span class="meta">@Suppress(<span class="string">&quot;VariableNaming&quot;</span>, <span class="string">&quot;PropertyName&quot;</span>)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> ANDROID_SUPPORT_FRAGMENT_CLASS_NAME =</span><br><span class="line">    StringBuilder(<span class="string">&quot;android.&quot;</span>).append(<span class="string">&quot;support.v4.app.Fragment&quot;</span>)</span><br><span class="line">        .toString()</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> ANDROID_SUPPORT_FRAGMENT_DESTROY_WATCHER_CLASS_NAME =</span><br><span class="line">    <span class="string">&quot;leakcanary.internal.AndroidSupportFragmentDestroyWatcher&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">install</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    application: <span class="type">Application</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    objectWatcher: <span class="type">ObjectWatcher</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    configProvider: () -&gt; <span class="type">AppWatcher</span>.<span class="type">Config</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> fragmentDestroyWatchers = mutableListOf&lt;(Activity) -&gt; <span class="built_in">Unit</span>&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SDK_INT &gt;= O) &#123;</span><br><span class="line">      fragmentDestroyWatchers.add(</span><br><span class="line">          AndroidOFragmentDestroyWatcher(objectWatcher, configProvider)</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AndroidX </span></span><br><span class="line">    getWatcherIfAvailable(</span><br><span class="line">        ANDROIDX_FRAGMENT_CLASS_NAME,</span><br><span class="line">        ANDROIDX_FRAGMENT_DESTROY_WATCHER_CLASS_NAME,</span><br><span class="line">        objectWatcher,</span><br><span class="line">        configProvider</span><br><span class="line">    )?.let &#123;</span><br><span class="line">      fragmentDestroyWatchers.add(it)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Support </span></span><br><span class="line">    getWatcherIfAvailable(</span><br><span class="line">        ANDROID_SUPPORT_FRAGMENT_CLASS_NAME,</span><br><span class="line">        ANDROID_SUPPORT_FRAGMENT_DESTROY_WATCHER_CLASS_NAME,</span><br><span class="line">        objectWatcher,</span><br><span class="line">        configProvider</span><br><span class="line">    )?.let &#123;</span><br><span class="line">      fragmentDestroyWatchers.add(it)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fragmentDestroyWatchers.size == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    application.registerActivityLifecycleCallbacks(<span class="keyword">object</span> : Application.ActivityLifecycleCallbacks <span class="keyword">by</span> noOpDelegate() &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityCreated</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        activity: <span class="type">Activity</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">      )</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (watcher <span class="keyword">in</span> fragmentDestroyWatchers) &#123;</span><br><span class="line">          watcher(activity)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>AndroidXFragmentDestroyWatcher</code>ã€<code>AndroidSupportFragmentDestroyWatcher</code>ã€<code>AndroidOFragmentDestroyWatcher</code> åœ¨é€»è¾‘ä¸Šå¾ˆç±»ä¼¼ï¼Œä¸”å°± <code>AndroidXFragmentDestroyWatcher</code> åŒæ—¶æä¾›äº† <code>ViewModel</code> å†…å­˜æ³„éœ²çš„æ£€æµ‹åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™é‡Œåªçœ‹ <code>AndroidXFragmentDestroyWatcher</code> å°±è¡Œ</p>
<p><code>AndroidXFragmentDestroyWatcher</code> çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š</p>
<ul>
<li>åœ¨ invoke æ–¹æ³•é‡Œå‘ Activity çš„ FragmentManager ä»¥åŠ childFragmentManager æ³¨å†Œä¸€ä¸ª FragmentLifecycleCallbackï¼Œé€šè¿‡è¯¥å›è°ƒæ‹¿åˆ° onFragmentViewDestroyed å’Œ onFragmentDestroyed çš„äº‹ä»¶é€šçŸ¥ï¼Œæ”¶åˆ°é€šçŸ¥æ—¶å°±é€šè¿‡ ObjectWatcher å¯åŠ¨æ£€æµ‹</li>
<li>åœ¨ onFragmentCreated å›è°ƒé‡Œé€šè¿‡ ViewModelClearedWatcher æ¥å¯åŠ¨å’Œ Fragment å…³è”çš„ ViewModel çš„å†…å­˜æ³„éœ²æ£€æµ‹é€»è¾‘</li>
<li>åœ¨ invoke æ–¹æ³•é‡Œé€šè¿‡ ViewModelClearedWatcher æ¥å¯åŠ¨å’Œ Activity å…³è”çš„ ViewModel çš„å†…å­˜æ³„éœ²æ£€æµ‹</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">AndroidXFragmentDestroyWatcher</span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> objectWatcher: ObjectWatcher,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> configProvider: () -&gt; Config</span><br><span class="line">) : (Activity) -&gt; <span class="built_in">Unit</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> fragmentLifecycleCallbacks = <span class="keyword">object</span> : FragmentManager.FragmentLifecycleCallbacks() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFragmentCreated</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      fm: <span class="type">FragmentManager</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">      fragment: <span class="type">Fragment</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">      savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">      ViewModelClearedWatcher.install(fragment, objectWatcher, configProvider)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFragmentViewDestroyed</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      fm: <span class="type">FragmentManager</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">      fragment: <span class="type">Fragment</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">      <span class="keyword">val</span> view = fragment.view</span><br><span class="line">      <span class="keyword">if</span> (view != <span class="literal">null</span> &amp;&amp; configProvider().watchFragmentViews) &#123;</span><br><span class="line">        objectWatcher.watch(</span><br><span class="line">            view, <span class="string">&quot;<span class="subst">$&#123;fragment::class.java.name&#125;</span> received Fragment#onDestroyView() callback &quot;</span> +</span><br><span class="line">            <span class="string">&quot;(references to its views should be cleared to prevent leaks)&quot;</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFragmentDestroyed</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      fm: <span class="type">FragmentManager</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">      fragment: <span class="type">Fragment</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (configProvider().watchFragments) &#123;</span><br><span class="line">        objectWatcher.watch(</span><br><span class="line">            fragment, <span class="string">&quot;<span class="subst">$&#123;fragment::class.java.name&#125;</span> received Fragment#onDestroy() callback&quot;</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">is</span> FragmentActivity) &#123;</span><br><span class="line">      <span class="keyword">val</span> supportFragmentManager = activity.supportFragmentManager</span><br><span class="line">      supportFragmentManager.registerFragmentLifecycleCallbacks(fragmentLifecycleCallbacks, <span class="literal">true</span>)</span><br><span class="line">      ViewModelClearedWatcher.install(activity, objectWatcher, configProvider)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fragment å’Œ FragmentView èµ°å‘ <code>Destroyed</code> æ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹å®ƒä»¬éƒ½æ˜¯ä¸ä¼šè¢«å¤ç”¨çš„ï¼Œåº”è¯¥ä¼šå¾ˆå¿«å°±è¢« GC å›æ”¶ï¼Œä¸”å®ƒä»¬æœ¬è´¨ä¸Šéƒ½åªæ˜¯ä¸€ç§å¯¹è±¡ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ <code>ObjectWatcher</code> è¿›è¡Œæ£€æµ‹å³å¯</p>
<h1 id="å…­ã€ViewModelClearedWatcherï¼šæ£€æµ‹ViewModel"><a href="#å…­ã€ViewModelClearedWatcherï¼šæ£€æµ‹ViewModel" class="headerlink" title="å…­ã€ViewModelClearedWatcherï¼šæ£€æµ‹ViewModel"></a>å…­ã€ViewModelClearedWatcherï¼šæ£€æµ‹ViewModel</h1><p>å’Œ Fragmentã€FragmentView ç›¸æ¯”ï¼ŒViewModel å°±æ¯”è¾ƒç‰¹æ®Šäº†ï¼Œç”±äºå¯èƒ½å­˜åœ¨ä¸€ä¸ª Activity å’Œå¤šä¸ª Fragment åŒæ—¶æŒæœ‰ä¸€ä¸ª ViewModel å®ä¾‹çš„æƒ…å†µï¼Œè€Œ leakcanary æ— æ³•çŸ¥é“ ViewModel åˆ°åº•æ˜¯åŒæ—¶è¢«å‡ ä¸ªæŒæœ‰è€…æ‰€æŒæœ‰ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡å•ç‹¬ä¸€ä¸ª Activity å’Œ Fragment çš„ <code>Destroyed</code> å›è°ƒæ¥å¯åŠ¨å¯¹ ViewModel çš„æ£€æµ‹ã€‚å¹¸å¥½ ViewMode ä¹Ÿæä¾›äº† <code>onCleared()</code> çš„å›è°ƒäº‹ä»¶ï¼Œleakcanary å°±é€šè¿‡è¯¥å›è°ƒæ¥çŸ¥é“ ViewModel æ˜¯ä»€ä¹ˆæ—¶å€™éœ€è¦è¢«å›æ”¶ã€‚å¯¹ ViewModel çš„å®ç°åŸç†ä¸æ¸…æ¥šçš„åŒå­¦å¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://juejin.im/post/6873356946896846856">ä»æºç çœ‹ Jetpackï¼ˆ6ï¼‰-ViewModelæºç è¯¦è§£</a></p>
<p><code>ViewModelClearedWatcher</code> çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š</p>
<ul>
<li>ViewModelClearedWatcher ç»§æ‰¿äº ViewModelï¼Œå½“æ‹¿åˆ° ViewModelStoreOwner å®ä¾‹ï¼ˆActivity æˆ–è€… Fragmentï¼‰åï¼Œå°±åˆ›å»ºä¸€ä¸ªå’Œè¯¥å®ä¾‹ç»‘å®šçš„ ViewModelClearedWatcher å¯¹è±¡</li>
<li>ViewModelClearedWatcher é€šè¿‡åå°„è·å–åˆ° ViewModelStore ä¸­çš„ mMap å˜é‡ï¼Œè¯¥å˜é‡å°±å­˜å‚¨äº†æ‰€æœ‰çš„ Viewmodel å®ä¾‹</li>
<li>å½“ ViewModelClearedWatcher çš„ onCleared() æ–¹æ³•è¢«å›è°ƒäº†ï¼Œå°±è¯´æ˜äº†æ‰€æœ‰å’Œ Activity æˆ–è€… Fragment ç»‘å®šçš„ ViewModel å®ä¾‹éƒ½ä¸å†è¢«éœ€è¦äº†ï¼Œæ­¤æ—¶å°±å¯ä»¥å¼€å§‹ç›‘æµ‹æ‰€æœ‰çš„ ViewModel å®ä¾‹äº†</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">ViewModelClearedWatcher</span>(</span><br><span class="line">        storeOwner: ViewModelStoreOwner,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> objectWatcher: ObjectWatcher,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> configProvider: () -&gt; Config</span><br><span class="line">) : ViewModel() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModelMap: Map&lt;String, ViewModel&gt;?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// We could call ViewModelStore#keys with a package spy in androidx.lifecycle instead,</span></span><br><span class="line">        <span class="comment">// however that was added in 2.1.0 and we support AndroidX first stable release. viewmodel-2.0.0</span></span><br><span class="line">        <span class="comment">// does not have ViewModelStore#keys. All versions currently have the mMap field.</span></span><br><span class="line">        viewModelMap = <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> mMapField = ViewModelStore::<span class="keyword">class</span>.java.getDeclaredField(<span class="string">&quot;mMap&quot;</span>)</span><br><span class="line">            mMapField.isAccessible = <span class="literal">true</span></span><br><span class="line">            <span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">            mMapField[storeOwner.viewModelStore] <span class="keyword">as</span> Map&lt;String, ViewModel&gt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ignored: Exception) &#123;</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCleared</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (viewModelMap != <span class="literal">null</span> &amp;&amp; configProvider().watchViewModels) &#123;</span><br><span class="line">            viewModelMap.values.forEach &#123; viewModel -&gt;</span><br><span class="line">                objectWatcher.watch(</span><br><span class="line">                        viewModel, <span class="string">&quot;<span class="subst">$&#123;viewModel::class.java.name&#125;</span> received ViewModel#onCleared() callback&quot;</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">install</span><span class="params">(storeOwner: <span class="type">ViewModelStoreOwner</span>, objectWatcher: <span class="type">ObjectWatcher</span>, configProvider: () -&gt; <span class="type">Config</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> provider = ViewModelProvider(storeOwner, <span class="keyword">object</span> : Factory &#123;</span><br><span class="line">              <span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">              <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel?&gt;</span> <span class="title">create</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T =</span><br><span class="line">                      ViewModelClearedWatcher(storeOwner, objectWatcher, configProvider) <span class="keyword">as</span> T</span><br><span class="line">            &#125;)</span><br><span class="line">            provider.<span class="keyword">get</span>(ViewModelClearedWatcher::<span class="keyword">class</span>.java)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ä¸ƒã€æ£€æµ‹åˆ°å†…å­˜æ³„éœ²åçš„æµç¨‹"><a href="#ä¸ƒã€æ£€æµ‹åˆ°å†…å­˜æ³„éœ²åçš„æµç¨‹" class="headerlink" title="ä¸ƒã€æ£€æµ‹åˆ°å†…å­˜æ³„éœ²åçš„æµç¨‹"></a>ä¸ƒã€æ£€æµ‹åˆ°å†…å­˜æ³„éœ²åçš„æµç¨‹</h1><p>æˆ‘ä»¬ä¸å¯èƒ½åœ¨ Activity åˆšè¢«å›è°ƒäº† <code>onDestroy</code> æ–¹æ³•å°±é©¬ä¸Šæ¥åˆ¤æ–­ <code>ReferenceQueue</code> ä¸­æ˜¯å¦æœ‰å€¼ï¼Œå› ä¸º JVM çš„ GC æ—¶æœºæ˜¯ä¸ç¡®å®šçš„ï¼ŒActivity å¯¹è±¡å¯èƒ½ä¸ä¼šé‚£ä¹ˆå¿«å°±è¢«å›æ”¶ï¼Œæ‰€ä»¥éœ€è¦å»¶è¿Ÿä¸€æ®µæ—¶é—´åå†æ¥æ£€æµ‹ã€‚è€Œå³ä½¿å»¶è¿Ÿæ£€æµ‹äº†ï¼Œä¹Ÿå¯èƒ½ä¼šå­˜åœ¨<strong>åº”ç”¨æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„éœ²åªæ˜¯ç³»ç»Ÿè¿˜æœªæ‰§è¡Œ GC</strong> çš„æƒ…å†µï¼Œæ‰€ä»¥å°±éœ€è¦å»ä¸»åŠ¨è§¦å‘ GCï¼Œç»è¿‡å‡ è½®æ£€æµ‹åæ‰å¯ä»¥ç¡®å®šå½“å‰åº”ç”¨æ˜¯å¦çš„ç¡®å‘ç”Ÿäº†å†…å­˜æ³„éœ²</p>
<p>è¿™é‡Œå°±æ¥çœ‹ä¸‹å…·ä½“çš„æ£€æµ‹æµç¨‹</p>
<p><code>ObjectWatcher</code> å¯¹è±¡åŒ…å«äº†ä¸€ä¸ª <code>Executor</code> å‚æ•°ï¼š<code>checkRetainedExecutor</code>ã€‚æ£€æµ‹æ“ä½œçš„è§¦å‘æ—¶æœºå°±å–å†³äºå‘ <code>checkRetainedExecutor</code> æäº¤çš„ä»»åŠ¡åœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«æ‰§è¡Œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectWatcher</span> <span class="keyword">constructor</span>(<span class="keyword">private</span> <span class="keyword">val</span> clock: Clock, <span class="keyword">private</span> <span class="keyword">val</span> checkRetainedExecutor: Executor,</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Calls to [watch] will be ignored when [isEnabled] returns false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> isEnabled: () -&gt; <span class="built_in">Boolean</span> = &#123; <span class="literal">true</span> &#125;</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    Â·Â·Â·</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Watches the provided [watchedObject].</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description Describes why the object is watched.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">watch</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            watchedObject: <span class="type">Any</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            description: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        removeWeaklyReachableObjects()</span><br><span class="line">        <span class="keyword">val</span> key = UUID.randomUUID()</span><br><span class="line">                .toString()</span><br><span class="line">        <span class="keyword">val</span> watchUptimeMillis = clock.uptimeMillis()</span><br><span class="line">        <span class="keyword">val</span> reference =</span><br><span class="line">                KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)</span><br><span class="line">        SharkLog.d &#123;</span><br><span class="line">            <span class="string">&quot;Watching &quot;</span> +</span><br><span class="line">                    (<span class="keyword">if</span> (watchedObject <span class="keyword">is</span> Class&lt;*&gt;) watchedObject.toString() <span class="keyword">else</span> <span class="string">&quot;instance of <span class="subst">$&#123;watchedObject.javaClass.name&#125;</span>&quot;</span>) +</span><br><span class="line">                    (<span class="keyword">if</span> (description.isNotEmpty()) <span class="string">&quot; (<span class="variable">$description</span>)&quot;</span> <span class="keyword">else</span> <span class="string">&quot;&quot;</span>) +</span><br><span class="line">                    <span class="string">&quot; with key <span class="variable">$key</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        watchedObjects[key] = reference</span><br><span class="line">        <span class="comment">//é‡ç‚¹</span></span><br><span class="line">        checkRetainedExecutor.execute &#123;</span><br><span class="line">            moveToRetained(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­ key å…³è”çš„å¯¹è±¡æ˜¯å¦å·²ç»æ³„éœ²</span></span><br><span class="line">    <span class="comment">//æ˜¯çš„è¯åˆ™å°†æ›´æ–°å…¶ retainedUptimeMillis å€¼ï¼Œä»¥æ­¤æ¥æ ‡è®°å…¶å‘ç”Ÿäº†æ³„éœ²</span></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">moveToRetained</span><span class="params">(key: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        removeWeaklyReachableObjects()</span><br><span class="line">        <span class="keyword">val</span> retainedRef = watchedObjects[key]</span><br><span class="line">        <span class="keyword">if</span> (retainedRef != <span class="literal">null</span>) &#123;</span><br><span class="line">            retainedRef.retainedUptimeMillis = clock.uptimeMillis()</span><br><span class="line">            <span class="comment">//é‡ç‚¹ï¼Œå‘å¤–å‘å‡ºå¯èƒ½æœ‰å†…å­˜æ³„éœ²çš„é€šçŸ¥</span></span><br><span class="line">            onObjectRetainedListeners.forEach &#123; it.onObjectRetained() &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ObjectWatcher</code> å¯¹è±¡åˆæ˜¯åœ¨ <code>InternalAppWatcher</code> é‡Œåˆå§‹åŒ–çš„ï¼Œ<code>checkRetainedExecutor</code> åœ¨æ”¶åˆ°ä»»åŠ¡åä¼šé€šè¿‡ <code>Handler</code> æ¥å»¶æ—¶äº”ç§’æ‰§è¡Œ</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> InternalAppWatcher &#123;</span><br><span class="line"></span><br><span class="line">  Â·Â·Â·	</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> mainHandler <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Handler(Looper.getMainLooper())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> checkRetainedExecutor = Executor &#123;</span><br><span class="line">    mainHandler.postDelayed(it, AppWatcher.config.watchDurationMillis)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">val</span> objectWatcher = ObjectWatcher(</span><br><span class="line">      clock = clock,</span><br><span class="line">      checkRetainedExecutor = checkRetainedExecutor,</span><br><span class="line">      isEnabled = &#123; <span class="literal">true</span> &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  Â·Â·Â·</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ObjectWatcher</code> çš„ <code>moveToRetained</code> æ–¹æ³•åˆä¼šé€šè¿‡ <code>onObjectRetained</code> å‘å¤–å‘å‡ºé€šçŸ¥ï¼š<strong>å½“å‰å¯èƒ½å‘ç”Ÿäº†å†…å­˜æ³„éœ²</strong>ã€‚<code>InternalLeakCanary</code> ä¼šæ”¶åˆ°è¿™ä¸ªé€šçŸ¥ï¼Œç„¶åäº¤ç”± <code>HeapDumpTrigger</code> æ¥è¿›è¡Œæ£€æµ‹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> InternalLeakCanary : (Application) -&gt; <span class="built_in">Unit</span>, OnObjectRetainedListener &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> heapDumpTrigger: HeapDumpTrigger</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onObjectRetained</span><span class="params">()</span></span> = scheduleRetainedObjectCheck()</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">scheduleRetainedObjectCheck</span><span class="params">()</span></span> &#123;</span><br><span class="line">    	<span class="keyword">if</span> (<span class="keyword">this</span>::heapDumpTrigger.isInitialized) &#123;</span><br><span class="line">      		heapDumpTrigger.scheduleRetainedObjectCheck()</span><br><span class="line">    	&#125;</span><br><span class="line"> 	&#125;</span><br><span class="line">    </span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ LeakCanary åˆ¤å®šå½“å‰çœŸçš„å­˜åœ¨å†…å­˜æ³„éœ²æ—¶ï¼Œå°±ä¼šè¿›è¡Œ <strong>DumpHeap</strong>ï¼Œæ‰¾åˆ°æ³„éœ²å¯¹è±¡çš„å¼•ç”¨é“¾ï¼Œè€Œè¿™ä¸ªæ“ä½œæ˜¯æ¯”è¾ƒ<strong>è´¹æ—¶è´¹å†…å­˜</strong>çš„ï¼Œå¯èƒ½ä¼šç›´æ¥å¯¼è‡´åº”ç”¨é¡µé¢æ— å“åº”ï¼Œæ‰€ä»¥ LeakCanary è¿›è¡Œ DumpHeap å‰ä¼šæœ‰è®¸å¤šå‰ç½®æ£€æŸ¥æ“ä½œå’Œå‰ç½®æ¡ä»¶ï¼Œå°±æ˜¯ä¸ºäº†å°½é‡å‡å°‘ DumpHeap æ¬¡æ•°ä»¥åŠåœ¨ DumpHeap æ—¶å°½é‡å‡å°‘å¯¹å¼€å‘äººå‘˜çš„å¹²æ‰°</p>
<p> <code>heapDumpTrigger</code> çš„ <code>scheduleRetainedObjectCheck()</code> æ–¹æ³•çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š</p>
<ol>
<li>è·å–å½“å‰è¿˜æœªå›æ”¶çš„å¯¹è±¡ä¸ªæ•° retainedKeysCountã€‚å¦‚æœä¸ªæ•°å¤§äº 0ï¼Œåˆ™å…ˆä¸»åŠ¨è§¦å‘ GCï¼Œå°½é‡å°è¯•å›æ”¶å¯¹è±¡ï¼Œé¿å…è¯¯åˆ¤ï¼Œç„¶åæ‰§è¡Œç¬¬äºŒæ­¥ï¼›å¦‚æœä¸ªæ•°ä¸º 0ï¼Œé‚£ä¹ˆæµç¨‹å°±ç»“æŸäº†</li>
<li>GC è¿‡åå†æ¬¡æ›´æ–° retainedKeysCount å€¼ï¼Œå¦‚æœå¯¹è±¡éƒ½è¢«å›æ”¶äº†ï¼ˆå³ retainedKeysCount å€¼ä¸º 0ï¼‰ï¼Œé‚£ä¹ˆæµç¨‹å°±ç»“æŸäº†ï¼Œå¦åˆ™å°±æ‰§è¡Œç¬¬ä¸‰æ­¥</li>
<li>å¦‚æœ retainedKeysCount å°äºé˜ˆå€¼ 5ï¼Œä¸”å½“å‰â€œåº”ç”¨å¤„äºå‰å°â€æˆ–è€…æ˜¯â€œåº”ç”¨å¤„äºåå°ä½†é€€åˆ°åå°çš„æ—¶é—´è¿˜æœªè¶…å‡ºäº”ç§’â€ï¼Œé‚£ä¹ˆå°±å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåœ¨äºŒåç§’åé‡æ–°æ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œå¦åˆ™æ‰§è¡Œç¬¬å››æ­¥</li>
<li>å¦‚æœä¸Šä¸€æ¬¡ DumpHeap ç¦»ç°åœ¨ä¸è¶³ä¸€åˆ†é’Ÿï¼Œé‚£ä¹ˆå°±å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ»¡ä¸€åˆ†é’Ÿåé‡æ–°æ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œå¦åˆ™æ‰§è¡Œç¬¬äº”æ­¥</li>
<li>æ­¤æ—¶å„ä¸ªæ¡ä»¶éƒ½æ»¡è¶³äº†ï¼Œå·²ç»å¯ä»¥ç¡®å®šå‘ç”Ÿäº†å†…å­˜æ³„æ¼ï¼Œå»æ‰§è¡Œ DumpHeap</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">HeapDumpTrigger</span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> application: Application,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> backgroundHandler: Handler,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> objectWatcher: ObjectWatcher,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> gcTrigger: GcTrigger,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> heapDumper: HeapDumper,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> configProvider: () -&gt; Config</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">scheduleRetainedObjectCheck</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            delayMillis: <span class="type">Long</span> = <span class="number">0</span>L</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> checkCurrentlyScheduledAt = checkScheduledAt</span><br><span class="line">        <span class="keyword">if</span> (checkCurrentlyScheduledAt &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœå½“å‰å·²ç»åœ¨è¿›è¡Œæ£€æµ‹äº†ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        checkScheduledAt = SystemClock.uptimeMillis() + delayMillis</span><br><span class="line">        backgroundHandler.postDelayed(&#123;</span><br><span class="line">          checkScheduledAt = <span class="number">0</span></span><br><span class="line">          checkRetainedObjects()</span><br><span class="line">        &#125;, delayMillis)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkRetainedObjects</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> iCanHasHeap = HeapDumpControl.iCanHasHeap()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> config = configProvider()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iCanHasHeap <span class="keyword">is</span> Nope) &#123;</span><br><span class="line">            <span class="keyword">if</span> (iCanHasHeap <span class="keyword">is</span> NotifyingNope) &#123;</span><br><span class="line">                <span class="comment">// Before notifying that we can&#x27;t dump heap, let&#x27;s check if we still have retained object.</span></span><br><span class="line">                <span class="keyword">var</span> retainedReferenceCount = objectWatcher.retainedObjectCount</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (retainedReferenceCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    gcTrigger.runGc()</span><br><span class="line">                    retainedReferenceCount = objectWatcher.retainedObjectCount</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> nopeReason = iCanHasHeap.reason()</span><br><span class="line">                <span class="keyword">val</span> wouldDump = !checkRetainedCount(</span><br><span class="line">                        retainedReferenceCount, config.retainedVisibleThreshold, nopeReason</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (wouldDump) &#123;</span><br><span class="line">                    <span class="keyword">val</span> uppercaseReason = nopeReason[<span class="number">0</span>].toUpperCase() + nopeReason.substring(<span class="number">1</span>)</span><br><span class="line">                    onRetainInstanceListener.onEvent(DumpingDisabled(uppercaseReason))</span><br><span class="line">                    showRetainedCountNotification(</span><br><span class="line">                            objectCount = retainedReferenceCount,</span><br><span class="line">                            contentText = uppercaseReason</span><br><span class="line">                    )</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                SharkLog.d &#123;</span><br><span class="line">                    application.getString(</span><br><span class="line">                            R.string.leak_canary_heap_dump_disabled_text, iCanHasHeap.reason()</span><br><span class="line">                    )</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å½“å‰è¿˜æœªå›æ”¶çš„å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">var</span> retainedReferenceCount = objectWatcher.retainedObjectCount</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retainedReferenceCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¸»åŠ¨è§¦å‘ GCï¼Œå°½é‡å°è¯•å›æ”¶å¯¹è±¡ï¼Œé¿å…è¯¯åˆ¤</span></span><br><span class="line">            gcTrigger.runGc()</span><br><span class="line">            retainedReferenceCount = objectWatcher.retainedObjectCount</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (checkRetainedCount(retainedReferenceCount, config.retainedVisibleThreshold))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> now = SystemClock.uptimeMillis()</span><br><span class="line">        <span class="keyword">val</span> elapsedSinceLastDumpMillis = now - lastHeapDumpUptimeMillis</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœä¸Šä¸€æ¬¡ DumpHeap ç¦»ç°åœ¨ä¸è¶³ä¸€åˆ†é’Ÿï¼Œé‚£ä¹ˆå°±å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ»¡ä¸€åˆ†é’Ÿåå†æ¬¡æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (elapsedSinceLastDumpMillis &lt; WAIT_BETWEEN_HEAP_DUMPS_MILLIS) &#123;</span><br><span class="line">            onRetainInstanceListener.onEvent(DumpHappenedRecently)</span><br><span class="line">            showRetainedCountNotification(</span><br><span class="line">                    objectCount = retainedReferenceCount,</span><br><span class="line">                    contentText = application.getString(R.string.leak_canary_notification_retained_dump_wait)</span><br><span class="line">            )</span><br><span class="line">            scheduleRetainedObjectCheck(</span><br><span class="line">                    delayMillis = WAIT_BETWEEN_HEAP_DUMPS_MILLIS - elapsedSinceLastDumpMillis</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dismissRetainedCountNotification()</span><br><span class="line">        <span class="comment">//å„ä¸ªæ¡ä»¶éƒ½æ»¡è¶³äº†ï¼Œå·²ç»å¯ä»¥ç¡®å®šå‘ç”Ÿäº†å†…å­˜æ³„æ¼ï¼Œå»æ‰§è¡Œ DumpiHeap</span></span><br><span class="line">        dumpHeap(retainedReferenceCount, retry = <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­å½“å‰æ˜¯å¦ç¬¦åˆ DumpHeap çš„æ¡ä»¶ï¼Œç¬¦åˆçš„è¯è¿”å› false</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> retainedKeysCount å½“å‰è¿˜æœªå›æ”¶çš„å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> retainedVisibleThreshold è§¦å‘ DumpHeap çš„é˜ˆå€¼</span></span><br><span class="line"><span class="comment">     * åªæœ‰å½“ retainedKeysCount å¤§äºç­‰äº retainedVisibleThreshold æ—¶æ‰ä¼šè§¦å‘ DumpHeapï¼Œé»˜è®¤å€¼æ˜¯ 5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nopeReason</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkRetainedCount</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            retainedKeysCount: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            retainedVisibleThreshold: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            nopeReason: <span class="type">String</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="comment">//ç”¨äºæ ‡è®°æœ¬æ¬¡æ£€æµ‹ç›¸å¯¹ä¸Šæ¬¡ï¼Œæœªå›æ”¶çš„å¯¹è±¡ä¸ªæ•°æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line">        <span class="keyword">val</span> countChanged = lastDisplayedRetainedObjectCount != retainedKeysCount</span><br><span class="line">        lastDisplayedRetainedObjectCount = retainedKeysCount</span><br><span class="line">        <span class="keyword">if</span> (retainedKeysCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (countChanged) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœ retainedKeysCount ä¸º 0ï¼Œä¸”å€¼ç›¸å¯¹ä¸Šæ¬¡æ£€æµ‹å‡å°‘äº†ï¼Œåˆ™è¯´æ˜æœ‰å¯¹è±¡è¢«å›æ”¶äº†</span></span><br><span class="line">                SharkLog.d &#123; <span class="string">&quot;All retained objects have been garbage collected&quot;</span> &#125;</span><br><span class="line">                onRetainInstanceListener.onEvent(NoMoreObjects)</span><br><span class="line">                showNoMoreRetainedObjectNotification()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åº”ç”¨æ˜¯å¦è¿˜åœ¨å‰å°</span></span><br><span class="line">        <span class="keyword">val</span> applicationVisible = applicationVisible</span><br><span class="line">        <span class="keyword">val</span> applicationInvisibleLessThanWatchPeriod = applicationInvisibleLessThanWatchPeriod</span><br><span class="line"></span><br><span class="line">        Â·Â·Â·</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retainedKeysCount &lt; retainedVisibleThreshold) &#123; <span class="comment">//è¿˜æœªè¾¾åˆ°é˜ˆå€¼</span></span><br><span class="line">            <span class="keyword">if</span> (applicationVisible || applicationInvisibleLessThanWatchPeriod) &#123;</span><br><span class="line">                <span class="keyword">if</span> (countChanged) &#123;</span><br><span class="line">                    onRetainInstanceListener.onEvent(BelowThreshold(retainedKeysCount))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åœ¨é€šçŸ¥æ æ˜¾ç¤ºå½“å‰æœªå›æ”¶çš„å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">                showRetainedCountNotification(</span><br><span class="line">                        objectCount = retainedKeysCount,</span><br><span class="line">                        contentText = application.getString(</span><br><span class="line">                                R.string.leak_canary_notification_retained_visible, retainedVisibleThreshold</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">//retainedKeysCount è¿˜æœªè¾¾åˆ°é˜ˆå€¼ï¼Œä¸”å½“å‰â€œåº”ç”¨å¤„äºå‰å°â€æˆ–è€…æ˜¯â€œåº”ç”¨å¤„äºåå°ä½†é€€åˆ°åå°çš„æ—¶é—´è¿˜æœªè¶…å‡ºäº”ç§’â€</span></span><br><span class="line">                <span class="comment">//æ­¤æ—¶å°±å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåœ¨äºŒåç§’åé‡æ–°å†æ£€æµ‹ä¸€é</span></span><br><span class="line">                scheduleRetainedObjectCheck(</span><br><span class="line">                        delayMillis = WAIT_FOR_OBJECT_THRESHOLD_MILLIS</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   Â·Â·Â·</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ›´åé¢çš„æµç¨‹å°±æ¶‰åŠå…·ä½“çš„ DumpHeap æ“ä½œäº†ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€äº†ï¼Œå› ä¸ºæˆ‘ä¹Ÿä¸å¤ªæ‡‚ï¼Œåç»­æœ‰æœºä¼šå†å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»äº†~~</p>
<h1 id="å…«ã€å°æç¤º"><a href="#å…«ã€å°æç¤º" class="headerlink" title="å…«ã€å°æç¤º"></a>å…«ã€å°æç¤º</h1><h2 id="1ã€æ£€æµ‹ä»»æ„å¯¹è±¡"><a href="#1ã€æ£€æµ‹ä»»æ„å¯¹è±¡" class="headerlink" title="1ã€æ£€æµ‹ä»»æ„å¯¹è±¡"></a>1ã€æ£€æµ‹ä»»æ„å¯¹è±¡</h2><p>é™¤äº† LeakCanary é»˜è®¤æ”¯æŒçš„å››ç§ç±»å‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸»åŠ¨æ£€æµ‹ä»»æ„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æ£€æµ‹ Serviceï¼š </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span> : <span class="type">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    AppWatcher.objectWatcher.watch(</span><br><span class="line">      watchedObject = <span class="keyword">this</span>,</span><br><span class="line">      description = <span class="string">&quot;MyService received Service#onDestroy() callback&quot;</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2ã€æ›´æ”¹é…ç½®é¡¹"><a href="#2ã€æ›´æ”¹é…ç½®é¡¹" class="headerlink" title="2ã€æ›´æ”¹é…ç½®é¡¹"></a>2ã€æ›´æ”¹é…ç½®é¡¹</h2><p>LeakCanary æä¾›çš„é»˜è®¤é…ç½®é¡¹å¤§å¤šæ•°æƒ…å†µå·²ç»å¾ˆé€‚åˆæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨äº†ï¼Œè€Œå¦‚æœæˆ‘ä»¬æƒ³è¦æ›´æ”¹ LeakCanary çš„é»˜è®¤é…ç½®é¡¹ï¼ˆä¾‹å¦‚ä¸å¸Œæœ›æ£€æµ‹ FragmentViewï¼‰ï¼Œå¯ä»¥åœ¨ Application ä¸­è¿›è¡Œæ›´æ”¹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DebugExampleApplication</span> : <span class="type">Application</span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate()</span><br><span class="line">    AppWatcher.config = AppWatcher.config.copy(watchFragmentViews = <span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº LeakCanary çš„å¼•ç”¨æ–¹å¼æ˜¯ <code>debugImplementation</code>ï¼Œåœ¨ <code>releas</code> ç¯å¢ƒä¸‹æ˜¯å¼•ç”¨ä¸åˆ° LeakCanary çš„ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…åœ¨ç”Ÿæˆ <code>release</code> åŒ…æ—¶éœ€è¦ä¸»åŠ¨æ¥åˆ é™¤è¿™è¡Œé…ç½®é¡¹ï¼Œéœ€è¦å°† <code>DebugExampleApplication</code> æ”¾åˆ° <code>src/debug/java</code> æ–‡ä»¶å¤¹ä¸­</p>
<h1 id="ä¹ã€ç»“å°¾"><a href="#ä¹ã€ç»“å°¾" class="headerlink" title="ä¹ã€ç»“å°¾"></a>ä¹ã€ç»“å°¾</h1><p>å¯ä»¥çœ‹å‡º <strong>Activityã€Fragmentã€FragmentViewã€ViewModel</strong> ç­‰å››ç§ç±»å‹çš„å†…å­˜æ£€æµ‹éƒ½æ˜¯éœ€è¦ä¾é  <code>ObjectWatcher</code> æ¥å®Œæˆçš„ï¼Œå› ä¸ºè¿™å››ç§ç±»å‹æœ¬è´¨ä¸Šéƒ½æ˜¯å±äºä¸åŒçš„å¯¹è±¡ã€‚è€Œ <code>ObjectWatcher</code> éœ€è¦ä¾é å¼•ç”¨é˜Ÿåˆ— <code>ReferenceQueue</code> æ¥å®ç°ï¼Œå› æ­¤ LeakCanary çš„åŸºæœ¬å®ç°åŸºç¡€å°±æ˜¯æ¥æºäº Java çš„åŸç”Ÿç‰¹æ€§</p>
<p>LeakCanary çš„æ•´ä½“æºç è®²å¾—ä¹Ÿå·®ä¸å¤šäº†ï¼Œåè¾¹å°±å†æ¥å†™ä¸€ç¯‡å…³äº<strong>å†…å­˜æ³„éœ²</strong>çš„æ‰©å±•é˜…è¯» ğŸ˜‚ğŸ˜‚</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>åƒè¶Š</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://qianyuebits.github.io/2017/05/17/Android-LeakCanary/">https://qianyuebits.github.io/2017/05/17/Android-LeakCanary/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/Android/"># Android</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>Â· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2023/04/11/%E8%AF%BB%E4%B9%A6%E7%AF%87-%E3%80%8A%E9%AB%98%E6%95%88%E8%83%BD%E4%BA%BA%E5%A3%AB%E7%9A%84%E4%B8%83%E4%B8%AA%E4%B9%A0%E6%83%AF%E3%80%8B/">è¯»ä¹¦ç¯‡:ã€Šé«˜æ•ˆèƒ½äººå£«çš„ä¸ƒä¸ªä¹ æƒ¯ã€‹</a>
            
            
            <a class="next" rel="next" href="/2014/05/25/Android-Handler/">Android Handler</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Â© åƒè¶Š | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>